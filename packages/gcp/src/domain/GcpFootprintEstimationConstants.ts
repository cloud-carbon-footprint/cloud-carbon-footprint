/*
 * Â© 2021 Thoughtworks, Inc.
 */
import {
  CloudConstantsByProvider,
  CloudConstantsEmissionsFactors,
  COMPUTE_PROCESSOR_TYPES,
  EstimateUnknownUsageBy,
  getWattsByAverageOrMedian,
} from '@cloud-carbon-footprint/core'

import {
  GCP_DUAL_REGIONS,
  GCP_MULTI_REGIONS,
  GCP_REGIONS,
} from '../lib/GCPRegions'
import { configLoader } from '@cloud-carbon-footprint/common'

export const GCP_CLOUD_CONSTANTS: CloudConstantsByProvider = {
  SSDCOEFFICIENT: 1.2, // watt hours / terabyte hour
  HDDCOEFFICIENT: 0.65, // watt hours / terabyte hour
  MIN_WATTS_MEDIAN: 0.68,
  MIN_WATTS_BY_COMPUTE_PROCESSOR: {
    // CPUs
    [COMPUTE_PROCESSOR_TYPES.CASCADE_LAKE.name]:
      COMPUTE_PROCESSOR_TYPES.CASCADE_LAKE.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.SKYLAKE.name]:
      COMPUTE_PROCESSOR_TYPES.SKYLAKE.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.BROADWELL.name]:
      COMPUTE_PROCESSOR_TYPES.BROADWELL.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.HASWELL.name]:
      COMPUTE_PROCESSOR_TYPES.HASWELL.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.COFFEE_LAKE.name]:
      COMPUTE_PROCESSOR_TYPES.COFFEE_LAKE.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.SANDY_BRIDGE.name]:
      COMPUTE_PROCESSOR_TYPES.SANDY_BRIDGE.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.IVY_BRIDGE.name]:
      COMPUTE_PROCESSOR_TYPES.IVY_BRIDGE.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_EPYC_1ST_GEN.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_EPYC_1ST_GEN.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_EPYC_2ND_GEN.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_EPYC_2ND_GEN.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_EPYC_3RD_GEN.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_EPYC_3RD_GEN.min_watts_avg,
    // GPUs
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_K520.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_K520.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_A10G.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_A10G.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_T4.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_T4.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_M60.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_M60.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_K80.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_K80.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_V100.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_V100.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_A100.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_A100.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P4.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P4.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P100.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P100.min_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_RADEON_PRO_V520.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_RADEON_PRO_V520.min_watts_avg,
  },
  getMinWatts: (computeProcessors: string[]): number => {
    const minWattsForProcessors: number[] = computeProcessors.map(
      (processor: string) => {
        return GCP_CLOUD_CONSTANTS.MIN_WATTS_BY_COMPUTE_PROCESSOR[processor]
      },
    )
    const wattsForProcessors: number = getWattsByAverageOrMedian(
      computeProcessors,
      minWattsForProcessors,
    )
    return wattsForProcessors
      ? wattsForProcessors
      : GCP_CLOUD_CONSTANTS.MIN_WATTS_MEDIAN
  },
  MAX_WATTS_MEDIAN: 4.11,
  MAX_WATTS_BY_COMPUTE_PROCESSOR: {
    // CPUs
    [COMPUTE_PROCESSOR_TYPES.CASCADE_LAKE.name]:
      COMPUTE_PROCESSOR_TYPES.CASCADE_LAKE.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.SKYLAKE.name]:
      COMPUTE_PROCESSOR_TYPES.SKYLAKE.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.BROADWELL.name]:
      COMPUTE_PROCESSOR_TYPES.BROADWELL.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.HASWELL.name]:
      COMPUTE_PROCESSOR_TYPES.HASWELL.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.COFFEE_LAKE.name]:
      COMPUTE_PROCESSOR_TYPES.COFFEE_LAKE.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.SANDY_BRIDGE.name]:
      COMPUTE_PROCESSOR_TYPES.SANDY_BRIDGE.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.IVY_BRIDGE.name]:
      COMPUTE_PROCESSOR_TYPES.IVY_BRIDGE.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_EPYC_1ST_GEN.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_EPYC_1ST_GEN.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_EPYC_2ND_GEN.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_EPYC_2ND_GEN.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_EPYC_3RD_GEN.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_EPYC_3RD_GEN.max_watts_avg,
    // GPUs
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_K520.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_K520.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_A10G.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_A10G.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_T4.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_T4.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_M60.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_M60.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_K80.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_K80.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_V100.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_V100.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_A100.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_A100.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P4.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P4.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P100.name]:
      COMPUTE_PROCESSOR_TYPES.NVIDIA_TESLA_P100.max_watts_avg,
    [COMPUTE_PROCESSOR_TYPES.AMD_RADEON_PRO_V520.name]:
      COMPUTE_PROCESSOR_TYPES.AMD_RADEON_PRO_V520.max_watts_avg,
  },
  getMaxWatts: (computeProcessors: string[]): number => {
    const maxWattsForProcessors: number[] = computeProcessors.map(
      (processor: string) => {
        return GCP_CLOUD_CONSTANTS.MAX_WATTS_BY_COMPUTE_PROCESSOR[processor]
      },
    )
    const wattsForProcessors: number = getWattsByAverageOrMedian(
      computeProcessors,
      maxWattsForProcessors,
    )

    return wattsForProcessors
      ? wattsForProcessors
      : GCP_CLOUD_CONSTANTS.MAX_WATTS_MEDIAN
  },
  NETWORKING_COEFFICIENT: 0.001, // kWh / Gb
  MEMORY_COEFFICIENT: 0.000392, // kWh / Gb
  PUE_AVG: 1.1,
  PUE_TRAILING_TWELVE_MONTH: {
    [GCP_REGIONS.US_EAST1]: 1.102,
    [GCP_REGIONS.US_CENTRAL1]: 1.11,
    [GCP_REGIONS.US_CENTRAL2]: 1.12,
    [GCP_REGIONS.US_WEST1]: 1.095,
    [GCP_REGIONS.EUROPE_WEST1]: 1.08,
    [GCP_REGIONS.EUROPE_WEST4]: 1.09,
    [GCP_REGIONS.EUROPE_NORTH1]: 1.09,
    [GCP_REGIONS.ASIA_EAST1]: 1.13,
    [GCP_REGIONS.ASIA_SOUTHEAST1]: 1.14,
    [GCP_REGIONS.SOUTHAMERICA_EAST1]: 1.09,
  },
  getPUE: (region: string): number => {
    return GCP_CLOUD_CONSTANTS.PUE_TRAILING_TWELVE_MONTH[region]
      ? GCP_CLOUD_CONSTANTS.PUE_TRAILING_TWELVE_MONTH[region]
      : GCP_CLOUD_CONSTANTS.PUE_AVG
  },
  AVG_CPU_UTILIZATION_2020: 50,
  REPLICATION_FACTORS: {
    CLOUD_STORAGE_SINGLE_REGION: 2,
    CLOUD_STORAGE_DUAL_REGION: 4,
    CLOUD_STORAGE_MULTI_REGION: 6,
    COMPUTE_ENGINE_REGIONAL_DISKS: 2,
    CLOUD_FILESTORE: 2,
    CLOUD_SQL_HIGH_AVAILABILITY: 2,
    CLOUD_MEMORY_STORE_REDIS: 2,
    CLOUD_SPANNER_SINGLE_REGION: 4,
    CLOUD_SPANNER_MULTI_REGION: 6,
    KUBERNETES_ENGINE: 3,
    DEFAULT: 1,
  },
  // these constants accumulate as the usage rows are mapped over
  KILOWATT_HOURS_BY_SERVICE_AND_USAGE_UNIT: {
    total: {},
  },
  ESTIMATE_UNKNOWN_USAGE_BY: EstimateUnknownUsageBy.USAGE_AMOUNT,
  SERVER_EXPECTED_LIFESPAN: 35040, // 4 years in hours
}

export const getGCPEmissionsFactors = (): CloudConstantsEmissionsFactors => {
  // These emission factors take into account Google Carbon Free Energy percentage in each region. Source: https://cloud.google.com/sustainability/region-carbon
  if (configLoader().GCP.USE_CARBON_FREE_ENERGY_PERCENTAGE)
    return {
      [GCP_REGIONS.US_CENTRAL1]: 0.00003178,
      [GCP_REGIONS.US_CENTRAL2]: 0.00003178,
      [GCP_REGIONS.US_EAST1]: 0.0003504,
      [GCP_REGIONS.US_EAST4]: 0.00015162,
      [GCP_REGIONS.US_WEST1]: 0.0000078,
      [GCP_REGIONS.US_WEST2]: 0.00011638,
      [GCP_REGIONS.US_WEST3]: 0.00038376,
      [GCP_REGIONS.US_WEST4]: 0.00036855,
      [GCP_REGIONS.ASIA_EAST1]: 0.0004428,
      [GCP_REGIONS.ASIA_EAST2]: 0.000453,
      [GCP_REGIONS.ASIA_NORTHEAST1]: 0.00048752,
      [GCP_REGIONS.ASIA_NORTHEAST2]: 0.000442,
      [GCP_REGIONS.ASIA_NORTHEAST3]: 0.00031533,
      [GCP_REGIONS.ASIA_SOUTH1]: 0.00063448,
      [GCP_REGIONS.ASIA_SOUTH2]: 0.000657,
      [GCP_REGIONS.ASIA_SOUTHEAST1]: 0.00047328,
      [GCP_REGIONS.ASIA_SOUTHEAST2]: 0.000647,
      [GCP_REGIONS.AUSTRALIA_SOUTHEAST1]: 0.00064703,
      [GCP_REGIONS.AUSTRALIA_SOUTHEAST2]: 0.000691,
      [GCP_REGIONS.EUROPE_CENTRAL2]: 0.000622,
      [GCP_REGIONS.EUROPE_NORTH1]: 0.00000798,
      [GCP_REGIONS.EUROPE_WEST1]: 0.00004452,
      [GCP_REGIONS.EUROPE_WEST2]: 0.00009471,
      [GCP_REGIONS.EUROPE_WEST3]: 0.00010841,
      [GCP_REGIONS.EUROPE_WEST4]: 0.000164,
      [GCP_REGIONS.EUROPE_WEST6]: 0.000087,
      [GCP_REGIONS.NORTHAMERICA_NORTHEAST1]: 0.000027,
      [GCP_REGIONS.SOUTHAMERICA_EAST1]: 0.00001236,
      [GCP_DUAL_REGIONS.ASIA1]: 0.00046476,
      [GCP_DUAL_REGIONS.EUR4]: 0.00008599,
      [GCP_DUAL_REGIONS.NAM4]: 0.00019109,
      [GCP_MULTI_REGIONS.ASIA]: 0.0005058233333,
      [GCP_MULTI_REGIONS.EU]: 0.0001723183333,
      [GCP_MULTI_REGIONS.US]: 0.00018025875,
      [GCP_REGIONS.UNKNOWN]: 0.0003035889286, // Average across all regions
    }
  // These emissions factors don't take into account Google's CFE%, and just use the Grid emissions factors published by Google.
  return {
    [GCP_REGIONS.US_CENTRAL1]: 0.000454,
    [GCP_REGIONS.US_CENTRAL2]: 0.000454,
    [GCP_REGIONS.US_EAST1]: 0.00048,
    [GCP_REGIONS.US_EAST4]: 0.000361,
    [GCP_REGIONS.US_WEST1]: 0.000078,
    [GCP_REGIONS.US_WEST2]: 0.000253,
    [GCP_REGIONS.US_WEST3]: 0.000533,
    [GCP_REGIONS.US_WEST4]: 0.000455,
    [GCP_REGIONS.ASIA_EAST1]: 0.00054,
    [GCP_REGIONS.ASIA_EAST2]: 0.000453,
    [GCP_REGIONS.ASIA_NORTHEAST1]: 0.000554,
    [GCP_REGIONS.ASIA_NORTHEAST2]: 0.000442,
    [GCP_REGIONS.ASIA_NORTHEAST3]: 0.000457,
    [GCP_REGIONS.ASIA_SOUTH1]: 0.000721,
    [GCP_REGIONS.ASIA_SOUTH2]: 0.000657,
    [GCP_REGIONS.ASIA_SOUTHEAST1]: 0.000493,
    [GCP_REGIONS.ASIA_SOUTHEAST2]: 0.000647,
    [GCP_REGIONS.AUSTRALIA_SOUTHEAST1]: 0.000727,
    [GCP_REGIONS.AUSTRALIA_SOUTHEAST2]: 0.000691,
    [GCP_REGIONS.EUROPE_CENTRAL2]: 0.000622,
    [GCP_REGIONS.EUROPE_NORTH1]: 0.000133,
    [GCP_REGIONS.EUROPE_WEST1]: 0.000212,
    [GCP_REGIONS.EUROPE_WEST2]: 0.000231,
    [GCP_REGIONS.EUROPE_WEST3]: 0.000293,
    [GCP_REGIONS.EUROPE_WEST4]: 0.00041,
    [GCP_REGIONS.EUROPE_WEST6]: 0.000087,
    [GCP_REGIONS.NORTHAMERICA_NORTHEAST1]: 0.000027,
    [GCP_REGIONS.SOUTHAMERICA_EAST1]: 0.000103,
    [GCP_DUAL_REGIONS.ASIA1]: 0.000498,
    [GCP_DUAL_REGIONS.EUR4]: 0.0002715,
    [GCP_DUAL_REGIONS.NAM4]: 0.000467,
    [GCP_MULTI_REGIONS.ASIA]: 0.0005515555556,
    [GCP_MULTI_REGIONS.EU]: 0.000284,
    [GCP_MULTI_REGIONS.US]: 0.0003734285714,
    [GCP_REGIONS.UNKNOWN]: 0.0004116296296, // Average of the above regions
  }
}
